<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover">
<title>Lines â€” Mobile v3 (native res)</title>
<style>
  :root{
    --bg:#000; --ink:#eee; --panel:#0f0f0f; --soft:#222; --accent:#2dd4bf;
    --touch:48px; --font: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    --safe-bottom: env(safe-area-inset-bottom, 0px);
  }
  *{box-sizing:border-box}
  html,body{margin:0;height:100%;background:var(--bg);color:var(--ink);font-family:var(--font);overscroll-behavior:contain}
  #app{display:grid;grid-template-rows:auto 1fr auto;min-height:100svh}
  header{position:sticky;top:0;z-index:5;display:flex;gap:8px;align-items:center;padding:8px; background:#0d0d0d;border-bottom:1px solid var(--soft)}
  header h1{font-size:15px;margin:0;flex:1}
  header .btn{height:var(--touch);padding:0 12px;background:#111;border:1px solid var(--soft);color:#fff;border-radius:10px}
  header .btn.primary{border-color:#1f2937}
  #stage{display:flex;align-items:center;justify-content:center;position:relative;background:#000;overflow:hidden}
  canvas{display:block;max-width:100vw;touch-action:none;background:#000}
  #drawerToggle{height:var(--touch);aspect-ratio:1;border-radius:12px}
  #uiDrawer{position:fixed;left:0;right:0;bottom:0;z-index:40;background:var(--panel);max-height:70svh;border-top:1px solid var(--soft);border-radius:14px 14px 0 0;
    transform:translateY(100%);transition:transform .25s ease;display:flex;flex-direction:column;padding-bottom:var(--safe-bottom)}
  #uiDrawer.open{transform:translateY(0)}
  #dragHandle{width:56px;height:6px;border-radius:6px;background:#333;margin:8px auto}
  #ui{overflow:auto;padding:4px 12px 16px}
  .row{display:grid;grid-template-columns:1fr;gap:6px;align-items:center;margin:10px 0}
  .row label{font-size:13px;opacity:.9}
  input[type=range]{width:100%}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  .hint{font-size:12px;color:#b5b5b5;margin:4px 0}
  .toolbar-bottom{display:flex;gap:10px;padding:8px calc(8px + env(safe-area-inset-right,0px)) calc(8px + var(--safe-bottom)) calc(8px + env(safe-area-inset-left,0px));border-top:1px solid var(--soft);background:#0d0d0d}
  .toolbar-bottom .btn{flex:1;min-width:100px;height:var(--touch);border-radius:12px;background:#111;border:1px solid var(--soft);color:#fff}
  .accent{color:var(--accent)}
  @media (min-width: 800px){
    #app{grid-template-columns:340px 1fr;grid-template-rows:auto 1fr}
    header{grid-column:1/-1}
    #stage{grid-column:2}
    #uiDrawer{position:static;transform:none;max-height:none;border-radius:0;border-left:1px solid var(--soft);padding-bottom:0}
    .toolbar-bottom{display:none}
  }
</style>
</head>
<body>
<div id="app">
  <header>
    <button id="drawerToggle" class="btn" aria-label="ParamÃ¨tres">â˜°</button>
    <h1>Lines â€” Mobile</h1>
    <button id="btnStart" class="btn primary">CamÃ©ra</button>
    <input id="file" type="file" accept="image/*" style="display:none">
    <button id="btnLoad" class="btn">Image</button>
  </header>

  <main id="stage" role="main" aria-label="AperÃ§u"></main>

  <div class="toolbar-bottom">
    <button id="btnSave" class="btn">PNG</button>
    <button id="btnSaveSVG" class="btn">SVG</button>
  </div>

  <aside id="uiDrawer" aria-label="Panneau de rÃ©glages">
    <div id="dragHandle"></div>
    <div id="ui">
      <div class="row"><label>Contraste</label><input id="contrast" type="range" min="0" max="255" value="120"></div>
      <div class="row"><label>DÃ©tail (pas)</label><input id="detail" type="range" min="1" max="12" value="3"></div>
      <div class="row"><label>Taille</label><input id="size" type="range" min="1" max="40" value="8"></div>
      <div class="row"><label>DensitÃ©</label><input id="density" type="range" min="0" max="1" step="0.01" value="1"></div>

      <div class="row"><label>Mix RVB â€” Rouge</label><input id="wR" type="range" min="0" max="200" step="1" value="21"></div>
      <div class="row"><label>Mix RVB â€” Vert</label><input id="wG" type="range" min="0" max="200" step="1" value="72"></div>
      <div class="row"><label>Mix RVB â€” Bleu</label><input id="wB" type="range" min="0" max="200" step="1" value="7"></div>
      <p class="hint">Le mix RVB pondÃ¨re chaque canal avant conversion N&B. Par dÃ©faut â‰ˆ Rec.709. Le total est normalisÃ© automatiquement.</p>

      <div class="grid2">
        <button id="btnReset" class="btn">RÃ©initialiser</button>
        <button id="btnHelp" class="btn">Aide</button>
      </div>
      <p id="warn" class="hint"></p>
    </div>
  </aside>
</div>

<script>
let video=null, stream=null, img=null;
let canvas, ctx, offSrc, offMask;
const UI = {};
const $ = id => document.getElementById(id);

function stageAvailableSize(){
  const header = document.querySelector('header');
  const toolbar = document.querySelector('.toolbar-bottom');
  const vv = window.visualViewport || {width: window.innerWidth, height: window.innerHeight};
  const headerH = header ? header.offsetHeight : 0;
  const toolbarH = toolbar ? toolbar.offsetHeight : 0;
  return { w: Math.floor(vv.width), h: Math.max(200, Math.floor(vv.height - headerH - toolbarH)) };
}

function fitCanvas(){
  const DPR = Math.max(1, window.devicePixelRatio||1);
  const {w:lw, h:lh} = stageAvailableSize(); // logical CSS px
  const dw = Math.floor(lw * DPR), dh = Math.floor(lh * DPR); // device px

  canvas.width = dw;
  canvas.height = dh;
  canvas.style.width = lw+'px';
  canvas.style.height = lh+'px';

  // map logical coordinates to device pixels
  ctx.setTransform(DPR,0,0,DPR,0,0);

  // also size processing buffers to logical px (so coords match UI)
  offSrc.width = lw; offSrc.height = lh;
  offMask.width = lw; offMask.height = lh;
}

async function startCamera(useEnv=true){
  try{
    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) throw new Error("getUserMedia indisponible");
    if (stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; }
    stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: useEnv ? {ideal:'environment'} : {ideal:'user'} }, audio:false });
    if (!video){
      video = document.createElement('video');
      video.setAttribute('playsinline','');
      video.muted = true;
    }
    video.srcObject = stream;
    await video.play();
  }catch(e){
    if (useEnv) return startCamera(false);
    console.warn(e);
    $('warn').textContent = "CamÃ©ra indisponible. Charge une image ou ouvre la page en HTTPS.";
  }
}

function drawFrame(){
  requestAnimationFrame(drawFrame);
  if (!ctx) return;
  ctx.fillStyle = '#000';
  ctx.fillRect(0,0,canvas.width,canvas.height);

  const lw = offSrc.width, lh = offSrc.height;

  // source into offSrc (cover)
  const octx = offSrc.getContext('2d');
  if (video && video.readyState>=2){
    const vs = Math.max(lw/video.videoWidth, lh/video.videoHeight);
    const w = Math.floor(video.videoWidth*vs), h=Math.floor(video.videoHeight*vs);
    const x = Math.floor((lw-w)/2), y=Math.floor((lh-h)/2);
    octx.drawImage(video,x,y,w,h);
  }else if (img){
    octx.clearRect(0,0,lw,lh);
    const s = Math.max(lw/img.width, lh/img.height); // cover
    const w = Math.floor(img.width*s), h=Math.floor(img.height*s);
    const x = Math.floor((lw-w)/2), y=Math.floor((lh-h)/2);
    octx.drawImage(img,x,y,w,h);
  }else{
    octx.fillStyle='#000'; octx.fillRect(0,0,lw,lh);
    for(let y=0;y<lh;y+=20){ for(let x=0;x<lw;x+=20){
      octx.fillStyle = ((x/20+y/20)%2)?'#111':'#222';
      octx.fillRect(x,y,20,20);
    }}
  }

  // grayscale with RGB weights into offMask
  const mctx = offMask.getContext('2d');
  mctx.drawImage(offSrc,0,0);
  const imgd = mctx.getImageData(0,0,lw,lh);
  const data = imgd.data;

  const wr=parseFloat(UI.wR.value)||0, wg=parseFloat(UI.wG.value)||0, wb=parseFloat(UI.wB.value)||0;
  const sum = (wr+wg+wb)||1;

  for (let i=0;i<data.length;i+=4){
    const r=data[i], g=data[i+1], b=data[i+2];
    const y = Math.max(0, Math.min(255, ((r*wr + g*wg + b*wb)/sum)))|0;
    data[i]=data[i+1]=data[i+2]=y; data[i+3]=255;
  }
  mctx.putImageData(imgd,0,0);

  // params
  const contrast = parseInt(UI.contrast.value);
  const step = Math.max(1, parseInt(UI.detail.value));
  const sizeMax = parseFloat(UI.size.value);
  const density = parseFloat(UI.density.value);

  // render 1:1 in logical coords (device mapping via DPR transform)
  const mdat = mctx.getImageData(0,0,lw,lh).data;
  ctx.fillStyle='#fff';
  for (let x=1; x<lw-1; x+=step){
    for (let y=1; y<lh-1; y+=step){
      if (hash2D(x,y) > density) continue;
      const idx = (x + y*lw)*4;
      const br = mdat[idx];
      if (br > contrast){
        const sz = sizeMax * (0.3 + 0.7*(br/255));
        ctx.beginPath();
        ctx.arc(x, y, sz*0.5, 0, Math.PI*2);
        ctx.fill();
      }
    }
  }
}

function hash2D(x,y){
  let n=(x|0)*374761393 + (y|0)*668265263; n=(n^(n>>>13))*1274126177; n=(n^(n>>>16))>>>0; return n/4294967295;
}

// helpers
function dataURLtoBlob(dataUrl){
  const arr = dataUrl.split(',');
  const mime = arr[0].match(/:(.*?);/)[1];
  const bstr = atob(arr[1]); let n=bstr.length; const u8=new Uint8Array(n);
  while(n--){ u8[n]=bstr.charCodeAt(n); }
  return new Blob([u8], {type:mime});
}

// init
window.addEventListener('DOMContentLoaded', async ()=>{
  ['contrast','detail','size','density','wR','wG','wB'].forEach(id=>UI[id]=$(id));

  $('drawerToggle').onclick = ()=> document.getElementById('uiDrawer').classList.toggle('open');
  document.getElementById('dragHandle').addEventListener('click', ()=> document.getElementById('uiDrawer').classList.toggle('open'));
  $('btnHelp').onclick = ()=> alert("Astuce :\n- CamÃ©ra en HTTPS\n- Mix RVB = pondÃ©ration avant N&B\n- PNG/SVG Ã  la rÃ©solution native de l'Ã©cran.");
  $('btnReset').onclick = ()=>{ UI.contrast.value=120; UI.detail.value=3; UI.size.value=8; UI.density.value=1; UI.wR.value=21; UI.wG.value=72; UI.wB.value=7; };

  $('btnLoad').onclick = ()=> $('file').click();
  $('file').onchange = (e)=>{
    const f = e.target.files[0]; if (!f) return;
    const url = URL.createObjectURL(f);
    const im = new Image();
    im.onload = ()=>{ img=im; URL.revokeObjectURL(url); };
    im.src = url;
  };

  $('btnStart').onclick = async ()=>{ await startCamera(true); document.getElementById('uiDrawer').classList.remove('open'); };

  $('btnSave').onclick = async ()=>{
    const dataUrl = canvas.toDataURL('image/png'); // full native res (canvas.width x canvas.height)
    const blob = dataURLtoBlob(dataUrl);
    const file = new File([blob], 'lines.png', {type:'image/png'});
    if (navigator.canShare && navigator.canShare({files:[file]}) && navigator.share){
      try{ await navigator.share({files:[file], title:'lines.png', text:'Export Lines'}); return; }catch(e){}
    }
    const a=document.createElement('a');
    a.download = 'lines.png';
    a.href = dataUrl;
    if (typeof a.download === 'undefined'){ window.open(dataUrl, '_blank'); }
    else { a.click(); }
  };

  $('btnSaveSVG').onclick = ()=>{
    const DPR = Math.max(1, window.devicePixelRatio||1);
    const lw = offMask.width, lh = offMask.height;      // logical
    const dw = Math.floor(lw*DPR), dh = Math.floor(lh*DPR); // device/native

    const mctx = offMask.getContext('2d');
    const mdat = mctx.getImageData(0,0,lw,lh).data;

    const contrast = parseInt(UI.contrast.value);
    const step = Math.max(1, parseInt(UI.detail.value));
    const sizeMax = parseFloat(UI.size.value);
    const density = parseFloat(UI.density.value);

    let parts = [];
    parts.push(`<svg xmlns="http://www.w3.org/2000/svg" width="${dw}" height="${dh}" viewBox="0 0 ${dw} ${dh}" fill="currentColor">`);
    for (let x=1; x<lw-1; x+=step){
      for (let y=1; y<lh-1; y+=step){
        if (hash2D(x,y) > density) continue;
        const idx=(x + y*lw)*4;
        const br = mdat[idx];
        if (br > contrast){
          const sz = sizeMax * (0.3 + 0.7*(br/255));
          const r = (sz*0.5 * DPR).toFixed(2);
          const cx = (x * DPR).toFixed(2);
          const cy = (y * DPR).toFixed(2);
          parts.push(`<circle cx="${cx}" cy="${cy}" r="${r}"/>`);
        }
      }
    }
    parts.push('</svg>');
    const blob = new Blob([parts.join('')], {type:'image/svg+xml'});

    const file = new File([blob], 'lines.svg', {type:'image/svg+xml'});
    if (navigator.canShare && navigator.canShare({files:[file]}) && navigator.share){
      navigator.share({files:[file], title:'lines.svg', text:'Export Lines'}).catch(()=>{
        const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.download='lines.svg'; a.href=url; a.click(); setTimeout(()=>URL.revokeObjectURL(url), 1500);
      });
    }else{
      const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.download='lines.svg'; a.href=url; a.click(); setTimeout(()=>URL.revokeObjectURL(url), 1500);
    }
  };

  if (!(location.protocol==='https:' || location.hostname==='localhost' || location.hostname==='127.0.0.1')){
    $('warn').innerHTML = 'ðŸ”’ Pour la camÃ©ra sur mobile, ouvre ce fichier via <span class="accent">HTTPS</span> (ou localhost).';
  }

  canvas = document.createElement('canvas');
  ctx = canvas.getContext('2d', {alpha:false});
  document.getElementById('stage').appendChild(canvas);
  offSrc = document.createElement('canvas');
  offMask = document.createElement('canvas');
  fitCanvas();
  requestAnimationFrame(drawFrame);
});

function scheduleFit(){ clearTimeout(scheduleFit._t); scheduleFit._t = setTimeout(fitCanvas, 80); }
window.addEventListener('resize', scheduleFit);
window.addEventListener('orientationchange', ()=> setTimeout(fitCanvas, 220));
if (window.visualViewport){
  visualViewport.addEventListener('resize', scheduleFit);
  visualViewport.addEventListener('scroll', scheduleFit);
}
</script>
</body>
</html>
